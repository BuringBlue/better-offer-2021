## Mysql

##### ACID

##### 事务隔离级别

##### 锁

##### Binglog和RedoLog

##### 索引原理

索引 >  事务 >  隔离级别  >  锁  >  mysql日志

### 1. MySQL是如何执行一条SQL的

#### 1.1 SQL执行顺序

from---where---group by---having---select---order by

#### 1.2 Server层按顺序执行sql的步骤

 客户端请求:

- **连接器**（验证用户身份，给予权限）
- **查询缓存**（存在缓存则直接返回，不存在则执行后续操作）
- **分析器**（对SQL进行词法分析和语法分析操作）
- **优化器**（主要对执行的sql优化选择最优的执行方案方法）
- **执行器**（执行时会先看用户是否有执行权限，有才去使用这个引擎提供的接口）
- **去引擎层获取数据返回**（如果开启查询缓存则会缓存查询结果）



<img src="https://camo.githubusercontent.com/6e4d96f95b371166d89165407eef8a2e36f8e0eb69249e6896f8b571b3e3a878/68747470733a2f2f67697465652e636f6d2f647265616d63617465722f626c6f672d696d672f7261772f6d61737465722f755069632f53514c2545362538392541372545382541312538432545372539412538342545352538352541382545392538332541382545382542462538372545372541382538422d4d6c533164352e706e67" alt="SQL执行的全部过程-MlS1d5" style="zoom:50%;" />



### 2. InnoDB和Myisam区别

**MySQL内部可以分为服务层和存储引擎层两部分**

- **服务层包括连接器、查询缓存、分析器、优化器、执行器等；**
- **存储引擎层负责数据的存储和提取**。说一下自己了解的InnoDB和MyISAM引擎。

#### 2.1 InnoDB

- 是 MySQL 默认的**事务型存储引擎**，只有在需要它不支持的特性时，才考虑使用其它存储引擎。
- 实现了四个标准的隔离级别，默认级别是**可重复读(REPEATABLE READ)**。在可重复读隔离级别下，通过**多版本并发控制**(MVCC)+ (Next-Key Locking)**防止幻影读**。
- 主索引是**聚簇索引**，在**索引中保存了数据**，从而避免直接读取磁盘，因此对查询性能有很大的提升。
- 内部做了很多优化，包括从磁盘读取数据时采用的**可预测性读**、能够加快读操作并且自动创建的**自适应哈希索引**、能够加速插入操作的**插入缓冲区**等。
- 支持真正的**在线热备份**。其它存储引擎不支持在线热备份，要获取一致性视图需要停止对所有表的写入，而在读写混合场景中，停止写入可能也意味着停止读取。

#### 2.2 Myisam

- 设计简单，数据以**紧密格式存储**。对于只读数据，或者表比较小、可以容忍修复操作，则依然可以使用它。
- 提供了大量的特性，包括**压缩表、空间数据索引**等。
- **不支持事务**。
- **不支持行级锁，只能对整张表加锁**，读取时会对需要读到的所有表加共享锁，写入时则对表加排它锁。但在表有读取操作的同时，也可以往表中插入新的记录，这被称为并发插入(CONCURRENT INSERT)。

#### 2.3 索引文件

我一般还会回答一个**索引文件**上的区别

##### MyISAM

1. MyISAM**索引文件和数据文件是分离**的，**索引文件仅保存数据记录的地址**，同样使用B+Tree作为索引结构，叶节点的**data域存放的是数据记录的地址**
2. 在MyISAM中，主索引和辅助索引（Secondary key）在结构上没有任何区别，只是主索引要求key是唯一的，而辅助索引的key可以重复
3. MyISAM中索引检索的算法为**首先按照B+Tree搜索算法搜索索引**，**如果指定的Key存在，则取出其data域的值，然后以data域的值为地址，读取相应数据记录**

##### InnoDB

1. **InnoDB的数据文件本身就是索引文件**，这棵树的叶节点**data域保存了完整的数据记录**（<u>聚集索引</u>）
2. InnoDB的**辅助索引data域存储相应记录主键的值而不是地址**
3. **聚集索引这种实现方式使得按主键的搜索十分高效**，**但是辅助索引搜索需要检索两遍索引：首先检索辅助索引获得主键，然后用主键到主索引中检索获得记录**。

### 3. ACID

答：**原子性(Atomicity)**、**一致性(Consistency)**、**隔离性(Isolation)和持久性(Durability)**

- 原子性：一个事务是一个不可分割的工作单位，**其中的操作要么都做，要么都不做**
- 一致性：事务执行前后，数据处于一种语义上合法的状态
- 隔离性：**多个事务并发执行的时候，事务内部的操作与其他事务是隔离的**，不相互干扰
- 持久性：**事务一旦提交，它对数据库的改变就应该是永久性的**

#### 3.1 并发事务带来的问题

答：**脏读、不可重复读和幻读**

#### 3.2 DB隔离级别



### 4. 索引

![索引用B+树的原因](/Users/wenzhuowang/Desktop/框图/索引用B+树的原因.png)



#### 4.1 索引失效

1. [索引失效的原理](https://cloud.tencent.com/developer/article/1704743)：**不遵循最佳左前缀**

   组合索引的底层其实按照第一个索引排序，从排序里面查第二个索引，以此类推。如果第一个索引失效，或者没有经过第一个索引，后面没发在前面的基础上查询。

2. **（索引失效的场景）查询什么时候不走索引**

（1）**模糊查询 %like**

（2）**非最左前缀顺序**

（3）**索引列参与计算,使用了函数**

（4）**where对null判断**

（5）**where不等于**

（6）or操作有至少一个字段没有索引

（7）需要回表的查询结果集过大（超过配置的范围）

（8）**将打算加索引的列设置为NOT NULL，否则将导致引擎放弃使用索引而进行全表扫描**

#### 4.2 为什么使用索引

